<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹¹æœå¤‡å¿˜å½•é£æ ¼ - å°çº¢ä¹¦ç¬”è®°ç”Ÿæˆå™¨</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Noto Sans SC', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 30px;
      display: flex;
      gap: 40px;
    }
    
    /* ========== å·¦ä¾§æ§åˆ¶é¢æ¿ ========== */
    .controls {
      width: 380px;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 24px;
      color: #fff;
      height: fit-content;
      max-height: calc(100vh - 60px);
      overflow-y: auto;
      position: sticky;
      top: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .controls::-webkit-scrollbar {
      width: 6px;
    }
    .controls::-webkit-scrollbar-track {
      background: transparent;
    }
    .controls::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    
    .controls-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .controls h2 {
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .quick-actions {
      display: flex;
      gap: 4px;
    }
    .quick-action {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .quick-action:hover {
      background: rgba(245, 166, 35, 0.3);
      transform: scale(1.1);
    }
    
    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .btn-row .btn {
      flex: 1;
      margin-top: 0;
    }
    
    /* ä¸»é¢˜åˆ‡æ¢å™¨ - æ”¾åœ¨é¢„è§ˆåŒºä¸Šæ–¹ */
    .theme-switcher {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      padding: 5px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      width: fit-content;
    }
    .theme-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 500;
    }
    .theme-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .theme-btn.active {
      background: linear-gradient(135deg, #f5a623 0%, #e8941f 100%);
      color: #fff;
    }
    .theme-btn .theme-icon { font-size: 16px; }
    
    .control-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .control-group label {
      display: block;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .control-group input,
    .control-group textarea,
    .control-group select {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s;
    }
    
    .control-group textarea {
      min-height: 280px;
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .control-group textarea.drag-over {
      border-color: #f5a623;
      box-shadow: 0 0 0 3px rgba(245, 166, 35, 0.2);
      background: rgba(245, 166, 35, 0.05);
      line-height: 1.8;
    }
    
    .control-group input:focus,
    .control-group textarea:focus,
    .control-group select:focus {
      outline: none;
      border-color: #f5a623;
      box-shadow: 0 0 0 3px rgba(245, 166, 35, 0.15);
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #f5a623 0%, #f7931e 100%);
      color: #fff;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(245, 166, 35, 0.3);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    
    .btn-small {
      width: auto;
      padding: 8px 16px;
      font-size: 13px;
      margin-top: 0;
    }
    
    .page-info {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(245, 166, 35, 0.1);
      border-radius: 12px;
      color: #f5a623;
      font-size: 14px;
    }
    
    .tips {
      margin-top: 15px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      line-height: 1.8;
    }
    
    .tips strong {
      color: #f5a623;
    }
    
    /* ä¿å­˜å½“å‰å†…å®¹æŒ‰é’® */
    .save-topic-btn {
      position: absolute;
      top: 0;
      right: 0;
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(245, 166, 35, 0.2);
      border: 1px solid rgba(245, 166, 35, 0.3);
      color: #f5a623;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .save-topic-btn:hover {
      background: rgba(245, 166, 35, 0.3);
    }
    
    /* ========== å³ä¾§é¢„è§ˆåŒº ========== */
    .preview-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .preview-area .theme-switcher {
      margin-bottom: 15px;
    }
    
    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 540px;
      margin-bottom: 15px;
    }
    
    .preview-title {
      color: rgba(255, 255, 255, 0.5);
      font-size: 13px;
    }
    
    .page-nav {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .page-nav button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .page-nav button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    
    .page-nav button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .page-nav .page-num {
      color: #fff;
      font-size: 14px;
      min-width: 60px;
      text-align: center;
    }
    
    /* ========== å¤‡å¿˜å½•æ ·å¼ ========== */
    .memo-page {
      width: 540px;
      height: 720px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      background: 
        url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E"),
        linear-gradient(180deg, #fefefe 0%, #fafafa 100%);
      background-blend-mode: overlay;
      background-size: 100px 100px, 100% 100%;
    }
    
    .memo-page::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.92);
      pointer-events: none;
    }
    
    .memo-inner {
      height: 100%;
      position: relative;
      z-index: 1;
      padding: 35px 35px;
      display: flex;
      flex-direction: column;
    }
    
    .memo-title {
      font-size: 32px;
      font-weight: 700;
      color: #d4830d;
      line-height: 1.3;
      margin-bottom: 15px;
      letter-spacing: -0.5px;
    }
    
    .memo-subtitle {
      font-size: 15px;
      color: #666;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .memo-subtitle .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      background: #f5a623;
      color: #fff;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .memo-body { flex: 1; overflow: hidden; }
    
    .memo-content {
      font-size: 17px;
      line-height: 1.65;
      color: #1a1a1a;
      white-space: pre-wrap;
      word-break: break-word;
      letter-spacing: 0.2px;
    }
    
    .memo-content .bold { font-weight: 600; color: #000; }
    .memo-content .highlight {
      background: linear-gradient(180deg, transparent 60%, rgba(245, 166, 35, 0.35) 60%);
      padding: 0 2px;
    }
    
    /* ç»“æ„åŒ–æ ¼å¼æ ·å¼ */
    .memo-content .text-line {
      margin-bottom: 3px;
    }
    .memo-content .text-line:empty {
      height: 8px;
    }
    
    .memo-content .section-title {
      background: linear-gradient(135deg, #f5a623 0%, #e8941f 100%);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      margin: 12px 0 6px 0;
      font-size: 15px;
      display: inline-block;
    }
    .memo-content .section-title:first-child {
      margin-top: 0;
    }
    .memo-content .section-label {
      background: rgba(255,255,255,0.25);
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 8px;
      font-size: 13px;
    }
    
    .memo-content .list-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 3px;
      padding-left: 4px;
    }
    .memo-content .list-dot {
      color: #f5a623;
      font-weight: bold;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .memo-content .step-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 4px;
      padding: 3px 0;
    }
    .memo-content .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: #f5a623;
      color: #fff;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 600;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .memo-content .quote-text {
      background: rgba(245, 166, 35, 0.12);
      color: #d4830d;
      padding: 1px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .memo-content .arrow {
      color: #f5a623;
      font-weight: bold;
      padding: 0 2px;
    }
    
    .memo-content .label {
      color: #888;
      font-weight: 500;
    }
    
    /* æ–°å¢æ ¼å¼æ ·å¼ */
    .memo-content .list-item.accent .list-dot { color: #e74c3c; }
    .memo-content .list-item.check .list-dot { color: #27ae60; font-size: 15px; }
    .memo-content .list-item.cross .list-dot { color: #e74c3c; font-size: 15px; }
    
    .memo-content .icon-line {
      margin-bottom: 4px;
      font-size: 16px;
    }
    
    .memo-content .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(245, 166, 35, 0.5), transparent);
      margin: 10px 0;
    }
    
    .memo-content .quote-block {
      border-left: 3px solid #f5a623;
      padding: 6px 12px;
      margin: 6px 0;
      background: rgba(245, 166, 35, 0.08);
      color: #666;
      font-style: italic;
    }
    
    .memo-content .strikethrough {
      text-decoration: line-through;
      color: #999;
    }
    
    .memo-content .code-inline {
      background: #f0f0f0;
      padding: 1px 6px;
      border-radius: 3px;
      font-family: 'SF Mono', 'Monaco', monospace;
      font-size: 0.9em;
      color: #e74c3c;
    }
    
    .memo-content .emphasis-box {
      background: linear-gradient(135deg, #f5a623, #e8941f);
      color: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    /* è¡¨æ ¼æ ·å¼ */
    .memo-content .table-wrapper {
      margin: 8px 0;
      overflow: hidden;
      border-radius: 8px;
      border: 1px solid rgba(245, 166, 35, 0.3);
    }
    
    .memo-content .memo-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .memo-content .memo-table th {
      background: linear-gradient(135deg, #f5a623 0%, #e8941f 100%);
      color: #fff;
      padding: 8px 10px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
    }
    
    .memo-content .memo-table td {
      padding: 6px 10px;
      border-bottom: 1px solid rgba(245, 166, 35, 0.15);
    }
    
    .memo-content .memo-table tr.odd { background: #fff; }
    .memo-content .memo-table tr.even { background: rgba(245, 166, 35, 0.05); }
    .memo-content .memo-table tr:last-child td { border-bottom: none; }
    
    /* å›¾ç‰‡æ ·å¼ */
    .memo-content .image-container {
      margin: 10px 0;
    }
    .memo-content .image-container.align-left { text-align: left; }
    .memo-content .image-container.align-center { text-align: center; }
    .memo-content .image-container.align-right { text-align: right; }
    
    .memo-content .memo-image {
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      object-fit: contain;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .memo-content .memo-image:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* å›¾ç‰‡å°ºå¯¸ */
    .memo-content .memo-image.size-small { max-width: 30%; max-height: 120px; }
    .memo-content .memo-image.size-medium { max-width: 50%; max-height: 180px; }
    .memo-content .memo-image.size-large { max-width: 75%; max-height: 240px; }
    .memo-content .memo-image.size-full { max-width: 100%; max-height: 300px; }
    
    .page-indicator {
      position: absolute;
      bottom: 25px;
      right: 40px;
      font-size: 13px;
      color: #999;
    }
    
    .memo-inner.no-title { padding-top: 25px; }
    
    /* ========== çŸ¥ä¹é£æ ¼ ========== */
    .theme-zhihu .memo-page {
      background: #fff;
      border-left: 4px solid #0066ff;
    }
    .theme-zhihu .memo-page::before {
      background: transparent;
    }
    .theme-zhihu .memo-title {
      color: #1a1a1a;
      font-size: 28px;
      font-weight: 700;
      line-height: 1.4;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .theme-zhihu .memo-subtitle {
      color: #0066ff;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .theme-zhihu .memo-subtitle .tag {
      background: #0066ff;
      border-radius: 4px;
    }
    .theme-zhihu .memo-content {
      color: #333;
      font-size: 16px;
      line-height: 1.8;
    }
    .theme-zhihu .memo-content .bold { color: #1a1a1a; }
    .theme-zhihu .memo-content .highlight {
      background: linear-gradient(180deg, transparent 60%, rgba(0, 102, 255, 0.2) 60%);
    }
    .theme-zhihu .memo-content .section-title {
      background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
      margin: 20px 0 12px 0;
    }
    .theme-zhihu .memo-content .list-dot { color: #0066ff; }
    .theme-zhihu .memo-content .step-num { background: #0066ff; }
    .theme-zhihu .memo-content .quote-text {
      background: rgba(0, 102, 255, 0.1);
      color: #0066ff;
    }
    .theme-zhihu .memo-content .quote-block {
      border-left-color: #0066ff;
      background: rgba(0, 102, 255, 0.05);
    }
    .theme-zhihu .memo-content .emphasis-box {
      background: linear-gradient(135deg, #0066ff, #0052cc);
    }
    .theme-zhihu .memo-content .arrow { color: #0066ff; }
    .theme-zhihu .memo-content .memo-table th {
      background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
    }
    .theme-zhihu .memo-content .table-wrapper {
      border-color: rgba(0, 102, 255, 0.3);
    }
    .theme-zhihu .memo-content .memo-table td {
      border-bottom-color: rgba(0, 102, 255, 0.1);
    }
    .theme-zhihu .memo-content .memo-table tr.even {
      background: rgba(0, 102, 255, 0.03);
    }
    .theme-zhihu .page-indicator { color: #999; }
    
    /* ========== æš—é»‘é£æ ¼ ========== */
    .theme-dark .memo-page {
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    }
    .theme-dark .memo-page::before {
      background: transparent;
    }
    .theme-dark .memo-title {
      color: #00d4ff;
      font-size: 30px;
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }
    .theme-dark .memo-subtitle { color: rgba(255, 255, 255, 0.6); }
    .theme-dark .memo-subtitle .tag {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
    }
    .theme-dark .memo-content {
      color: rgba(255, 255, 255, 0.85);
    }
    .theme-dark .memo-content .bold { color: #fff; }
    .theme-dark .memo-content .highlight {
      background: linear-gradient(180deg, transparent 60%, rgba(0, 212, 255, 0.3) 60%);
    }
    .theme-dark .memo-content .section-title {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #1a1a2e;
    }
    .theme-dark .memo-content .text-line { color: rgba(255, 255, 255, 0.85); }
    .theme-dark .memo-content .list-dot { color: #00d4ff; }
    .theme-dark .memo-content .step-num {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #1a1a2e;
    }
    .theme-dark .memo-content .quote-text {
      background: rgba(0, 212, 255, 0.15);
      color: #00d4ff;
    }
    .theme-dark .memo-content .quote-block {
      border-left-color: #00d4ff;
      background: rgba(0, 212, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
    }
    .theme-dark .memo-content .emphasis-box {
      background: linear-gradient(135deg, #00d4ff, #0099cc);
      color: #1a1a2e;
    }
    .theme-dark .memo-content .arrow { color: #00d4ff; }
    .theme-dark .memo-content .label { color: rgba(255, 255, 255, 0.5); }
    .theme-dark .memo-content .divider {
      background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.5), transparent);
    }
    .theme-dark .memo-content .code-inline {
      background: rgba(0, 212, 255, 0.15);
      color: #00d4ff;
    }
    .theme-dark .memo-content .memo-table th {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #1a1a2e;
    }
    .theme-dark .memo-content .table-wrapper {
      border-color: rgba(0, 212, 255, 0.3);
    }
    .theme-dark .memo-content .memo-table td {
      border-bottom-color: rgba(0, 212, 255, 0.15);
      color: rgba(255, 255, 255, 0.85);
    }
    .theme-dark .memo-content .memo-table tr.odd { background: rgba(0, 0, 0, 0.2); }
    .theme-dark .memo-content .memo-table tr.even { background: rgba(0, 212, 255, 0.05); }
    .theme-dark .page-indicator { color: rgba(255, 255, 255, 0.4); }
    
    /* ========== å¯¼å‡ºå®¹å™¨ ========== */
    .export-container { position: fixed; left: -9999px; top: 0; }
    .export-container .memo-page { width: 1080px; height: 1440px; border-radius: 0; }
    .export-container .memo-inner { padding: 70px 70px; }
    .export-container .memo-title { font-size: 64px; margin-bottom: 30px; }
    .export-container .memo-subtitle { font-size: 30px; margin-bottom: 24px; gap: 16px; }
    .export-container .memo-subtitle .tag { width: 44px; height: 44px; border-radius: 10px; font-size: 24px; }
    .export-container .memo-content { font-size: 34px; line-height: 1.65; }
    .export-container .page-indicator { bottom: 40px; right: 70px; font-size: 24px; }
    .export-container .memo-inner.no-title { padding-top: 50px; }
    /* å¯¼å‡ºæ—¶çš„ç»“æ„åŒ–æ ·å¼ */
    .export-container .memo-content .section-title { font-size: 30px; padding: 12px 24px; border-radius: 12px; margin: 24px 0 12px 0; }
    .export-container .memo-content .section-label { padding: 4px 14px; border-radius: 6px; font-size: 24px; margin-right: 14px; }
    .export-container .memo-content .text-line { margin-bottom: 6px; }
    .export-container .memo-content .list-item { margin-bottom: 6px; padding-left: 8px; }
    .export-container .memo-content .list-dot { margin-right: 14px; font-size: 34px; }
    .export-container .memo-content .step-item { margin-bottom: 8px; padding: 6px 0; }
    .export-container .memo-content .step-num { width: 40px; height: 40px; font-size: 24px; margin-right: 16px; }
    .export-container .memo-content .quote-text { padding: 2px 10px; border-radius: 6px; }
    .export-container .memo-content .arrow { padding: 0 4px; }
    /* å¯¼å‡ºæ—¶è¡¨æ ¼æ ·å¼ */
    .export-container .memo-content .table-wrapper { margin: 16px 0; border-radius: 16px; border-width: 2px; }
    .export-container .memo-content .memo-table { font-size: 28px; }
    .export-container .memo-content .memo-table th { padding: 16px 20px; font-size: 26px; }
    .export-container .memo-content .memo-table td { padding: 12px 20px; }
    /* å¯¼å‡ºæ—¶å…¶ä»–æ–°æ ·å¼ */
    .export-container .memo-content .divider { margin: 20px 0; height: 2px; }
    .export-container .memo-content .quote-block { padding: 12px 24px; margin: 12px 0; border-left-width: 6px; }
    .export-container .memo-content .code-inline { padding: 2px 12px; font-size: 28px; }
    .export-container .memo-content .emphasis-box { padding: 4px 16px; border-radius: 8px; }
    .export-container .memo-content .icon-line { font-size: 32px; margin-bottom: 8px; }
    /* å¯¼å‡ºæ—¶å›¾ç‰‡æ ·å¼ */
    .export-container .memo-content .image-container { margin: 20px 0; }
    .export-container .memo-content .memo-image { border-radius: 16px; cursor: default; }
    .export-container .memo-content .memo-image.size-small { max-width: 30%; max-height: 240px; }
    .export-container .memo-content .memo-image.size-medium { max-width: 50%; max-height: 360px; }
    .export-container .memo-content .memo-image.size-large { max-width: 75%; max-height: 480px; }
    .export-container .memo-content .memo-image.size-full { max-width: 100%; max-height: 600px; }
    
    /* ========== ä¾§è¾¹æ  ========== */
    .sidebar-toggle {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 100px;
      background: linear-gradient(135deg, #f5a623 0%, #f7931e 100%);
      border: none;
      border-radius: 0 12px 12px 0;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.3s;
      box-shadow: 2px 0 15px rgba(245, 166, 35, 0.3);
    }
    
    .sidebar-toggle:hover { width: 50px; }
    .sidebar-toggle span { writing-mode: vertical-rl; font-size: 13px; font-weight: 600; }
    
    .sidebar-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .sidebar-overlay.show { opacity: 1; pointer-events: auto; }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 420px;
      height: 100vh;
      background: #1a1a2e;
      z-index: 1002;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
    }
    .sidebar.show { transform: translateX(0); }
    
    .sidebar-header {
      padding: 20px 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-header h3 { color: #fff; font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .sidebar-header .close-btn {
      width: 32px; height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
    }
    
    /* ä¾§è¾¹æ æ ‡ç­¾é¡µ */
    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-tab {
      flex: 1;
      padding: 14px;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .sidebar-tab:hover { color: rgba(255, 255, 255, 0.8); }
    .sidebar-tab.active { color: #f5a623; }
    .sidebar-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 20%; right: 20%;
      height: 2px;
      background: #f5a623;
      border-radius: 1px;
    }
    
    .sidebar-actions {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-actions .btn { margin-top: 0; padding: 12px; }
    
    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 15px 20px;
    }
    .sidebar-body::-webkit-scrollbar { width: 6px; }
    .sidebar-body::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
    .sidebar-body::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* å¤‡ä»½åŒºåŸŸ */
    .sidebar-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
    }
    .backup-status {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 10px;
      text-align: center;
    }
    .backup-actions {
      display: flex;
      gap: 10px;
    }
    .backup-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .backup-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
    }
    .backup-btn-primary {
      background: linear-gradient(135deg, #f5a623 0%, #f7931e 100%);
      border-color: #f5a623;
      color: #fff;
      font-weight: 600;
    }
    .backup-btn-primary:hover {
      background: linear-gradient(135deg, #f7931e 0%, #e8850a 100%);
      border-color: #e8850a;
    }
    
    /* é€‰é¢˜å¡ç‰‡ */
    .topic-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    .topic-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(245, 166, 35, 0.3);
    }
    
    .topic-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .topic-card-title {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      line-height: 1.4;
      cursor: pointer;
    }
    .topic-card-title:hover { color: #f5a623; }
    
    /* å¿ƒå¾—å¡ç‰‡æ ·å¼ */
    .note-card { padding-left: 16px; }
    .note-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #fff;
      font-weight: 500;
    }
    .note-card-content {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.6;
      margin: 8px 0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .topic-card-actions { display: flex; gap: 5px; }
    .topic-card-actions button {
      width: 26px; height: 26px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .topic-card-actions .use-btn { background: rgba(76, 175, 80, 0.2); color: #81c784; }
    .topic-card-actions .use-btn:hover { background: rgba(76, 175, 80, 0.4); }
    .topic-card-actions .archive-btn { background: rgba(33, 150, 243, 0.2); color: #64b5f6; }
    .topic-card-actions .archive-btn:hover { background: rgba(33, 150, 243, 0.4); }
    .topic-card-actions .delete-btn { background: rgba(244, 67, 54, 0.2); color: #f44336; }
    .topic-card-actions .delete-btn:hover { background: rgba(244, 67, 54, 0.4); }
    
    .topic-card-content {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
      line-height: 1.5;
      max-height: 40px;
      overflow: hidden;
    }
    
    .topic-card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .topic-card-date { font-size: 11px; color: rgba(255, 255, 255, 0.3); }
    
    .topic-empty {
      text-align: center;
      padding: 30px 20px;
      color: rgba(255, 255, 255, 0.3);
    }
    .topic-empty-icon { font-size: 40px; margin-bottom: 10px; }
    .topic-empty-text { font-size: 13px; }
    
    /* ========== å¼¹çª—é€šç”¨æ ·å¼ ========== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    
    .modal {
      width: 500px;
      max-height: 80vh;
      background: #1a1a2e;
      border-radius: 20px;
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
    }
    .modal-overlay.show .modal { transform: scale(1); }
    
    .modal-header {
      padding: 18px 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h4 { color: #fff; font-size: 17px; }
    .modal-header .close-btn {
      width: 30px; height: 30px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .modal-body {
      padding: 20px 25px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-body .control-group { margin-bottom: 15px; }
    .modal-body .control-group:last-child { margin-bottom: 0; }
    .modal-body textarea { min-height: 120px; }
    .modal-body select {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .modal-body select option {
      background: #1a1a2e;
      color: #fff;
    }
    
    .modal-footer {
      padding: 15px 25px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .modal-footer .btn { width: auto; padding: 10px 20px; margin-top: 0; font-size: 14px; }
    .modal-footer .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      border-color: #c0392b;
    }
    .modal-footer .btn-danger:hover {
      background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
    }
    
    /* ========== å›¾ç‰‡ç¼–è¾‘å¼¹çª— ========== */
    .image-editor { width: 500px; }
    
    .img-preview-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .img-preview-box img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      object-fit: contain;
    }
    
    .img-settings .control-group { margin-bottom: 18px; }
    .img-settings .control-group label {
      display: block;
      margin-bottom: 10px;
      font-size: 14px;
      color: #aaa;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
    }
    .align-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: #aaa;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .align-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .align-btn.active {
      background: linear-gradient(135deg, #f5a623 0%, #e8941f 100%);
      border-color: #f5a623;
      color: #fff;
    }
    
    .size-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .size-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: #aaa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .size-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    .size-btn.active {
      background: linear-gradient(135deg, #f5a623 0%, #e8941f 100%);
      border-color: #f5a623;
      color: #fff;
    }
    .size-btn .size-icon { font-size: 20px; }
    .size-btn span:nth-child(2) { font-size: 13px; font-weight: 500; }
    .size-btn .size-hint { font-size: 11px; opacity: 0.7; }
    
    /* ========== æ ‡ç­¾è¯åº“å¼¹çª— ========== */
    .tags-modal .modal { width: 600px; }
    
    .tag-category {
      margin-bottom: 20px;
    }
    .tag-category:last-child { margin-bottom: 0; }
    
    .tag-category-title {
      font-size: 14px;
      font-weight: 600;
      color: #f5a623;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .tag-item {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tag-item:hover {
      background: rgba(245, 166, 35, 0.2);
      border-color: rgba(245, 166, 35, 0.4);
      color: #f5a623;
    }
    .tag-item.selected {
      background: rgba(245, 166, 35, 0.3);
      border-color: #f5a623;
      color: #f5a623;
    }
    
    .selected-tags {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
    }
    .selected-tags-title {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 10px;
    }
    .selected-tags-content {
      font-size: 14px;
      color: #fff;
      line-height: 1.6;
      word-break: break-all;
      min-height: 20px;
    }
    .selected-tags-content:empty::before {
      content: 'ç‚¹å‡»ä¸Šæ–¹æ ‡ç­¾æ·»åŠ ...';
      color: rgba(255, 255, 255, 0.3);
    }
    
    /* æ¨æµæœºåˆ¶å¼¹çª— */
    .flow-modal-content {
      max-width: 600px;
    }
    .flow-body {
      max-height: 65vh;
      overflow-y: auto;
    }
    .flow-section {
      margin-bottom: 24px;
    }
    .flow-section:last-child {
      margin-bottom: 0;
    }
    .flow-section-title {
      font-size: 15px;
      font-weight: 600;
      color: #f5a623;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(245, 166, 35, 0.2);
    }
    
    .flow-timeline {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .flow-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px 15px;
      border-left: 3px solid #f5a623;
    }
    .flow-time {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    .flow-desc {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 6px;
    }
    .flow-tip {
      font-size: 12px;
      color: #f5a623;
    }
    
    .flow-levels {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .flow-level {
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
    }
    .level-range {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    .level-issue {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }
    .flow-level.level-1 { border-left: 3px solid #ff6b6b; }
    .flow-level.level-2 { border-left: 3px solid #ffa94d; }
    .flow-level.level-3 { border-left: 3px solid #ffd43b; }
    .flow-level.level-4 { border-left: 3px solid #69db7c; }
    .flow-level.level-5 { border-left: 3px solid #4dabf7; }
    .flow-level.level-6 { border-left: 3px solid #da77f2; }
    
    .ces-formula {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .ces-item {
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
    }
    .ces-item.highlight {
      background: rgba(245, 166, 35, 0.2);
      color: #f5a623;
      font-weight: 600;
    }
    .ces-plus {
      color: rgba(255, 255, 255, 0.4);
      font-size: 16px;
    }
    .ces-tip {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
    }
    
    .checklist {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .check-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: background 0.2s;
    }
    .check-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .check-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #f5a623;
    }
    
    /* åŠ è½½æç¤º */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .loading-overlay.show { opacity: 1; pointer-events: auto; }
    
    .loading-spinner {
      width: 50px; height: 50px;
      border: 3px solid rgba(245, 166, 35, 0.2);
      border-top-color: #f5a623;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: #fff; margin-top: 20px; font-size: 14px; }
    
    /* å¤åˆ¶æˆåŠŸæç¤º */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(76, 175, 80, 0.95);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 9999;
      transition: transform 0.3s;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">
    ğŸ“š
    <span>å†…å®¹åº“</span>
  </button>
  
  <!-- ä¾§è¾¹æ é®ç½© -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
  
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>ğŸ“š å†…å®¹ç®¡ç†</h3>
      <button class="close-btn" onclick="toggleSidebar()">Ã—</button>
    </div>
    
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" onclick="switchTab('topics')">ğŸ“ é€‰é¢˜</button>
      <button class="sidebar-tab" onclick="switchTab('notes')">ğŸ’¡ å¿ƒå¾—</button>
      <button class="sidebar-tab" onclick="switchTab('history')">ğŸ“œ å†å²</button>
    </div>
    
    <!-- é€‰é¢˜åº“å†…å®¹ -->
    <div id="tab-topics" class="tab-content active">
      <div class="sidebar-actions">
        <button class="btn btn-primary" onclick="openNewTopicModal()">â• æ–°å»ºé€‰é¢˜</button>
      </div>
      <div class="sidebar-body" id="topic-list"></div>
    </div>
    
    <!-- å†™ä½œå¿ƒå¾—å†…å®¹ -->
    <div id="tab-notes" class="tab-content">
      <div class="sidebar-actions">
        <button class="btn btn-primary" onclick="openNewNoteModal()">â• è®°å½•å¿ƒå¾—</button>
      </div>
      <div class="sidebar-body" id="notes-list"></div>
    </div>
    
    <!-- å†å²è®°å½•å†…å®¹ -->
    <div id="tab-history" class="tab-content">
      <div class="sidebar-body" id="history-list"></div>
    </div>
    
    <!-- å¤‡ä»½åŒºåŸŸ -->
    <div class="sidebar-footer">
      <div class="backup-status" id="backup-status">ç‚¹å‡»ä¸‹æ–¹è®¾ç½®è‡ªåŠ¨ä¿å­˜è·¯å¾„</div>
      <div class="backup-actions">
        <button class="backup-btn backup-btn-primary" onclick="setupAutoSave()" title="è®¾ç½®è‡ªåŠ¨ä¿å­˜æ–‡ä»¶è·¯å¾„">ğŸ“ è®¾ç½®è·¯å¾„</button>
      </div>
      <div class="backup-actions" style="margin-top: 8px;">
        <button class="backup-btn" onclick="exportBackup()" title="æ‰‹åŠ¨å¯¼å‡ºå¤‡ä»½">ğŸ“¤ å¯¼å‡º</button>
        <button class="backup-btn" onclick="importBackup()" title="ä»æ–‡ä»¶æ¢å¤">ğŸ“¥ å¯¼å…¥</button>
      </div>
    </div>
  </div>
  
  <!-- æ–°å»ºå¿ƒå¾—å¼¹çª— -->
  <div class="modal-overlay" id="note-modal">
    <div class="modal">
      <div class="modal-header">
        <h4 id="note-modal-title">ğŸ’¡ è®°å½•å¿ƒå¾—</h4>
        <button class="close-btn" onclick="closeNoteModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="control-group">
          <label>å¿ƒå¾—ç±»å‹</label>
          <select id="note-type">
            <option value="success">âœ… æˆåŠŸç»éªŒ</option>
            <option value="fail">âŒ è¸©å‘æ•™è®­</option>
            <option value="idea">ğŸ’¡ çµæ„Ÿæƒ³æ³•</option>
            <option value="data">ğŸ“Š æ•°æ®å¤ç›˜</option>
          </select>
        </div>
        <div class="control-group">
          <label>å¿ƒå¾—å†…å®¹ *</label>
          <textarea id="note-content" placeholder="è®°å½•ä½ çš„è¿è¥å¿ƒå¾—ã€è¸©è¿‡çš„å‘ã€æˆåŠŸçš„ç»éªŒ..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNoteModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveNote()">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- æ–°å»ºé€‰é¢˜å¼¹çª— -->
  <div class="modal-overlay" id="topic-modal">
    <div class="modal">
      <div class="modal-header">
        <h4>ğŸ“ æ–°å»ºé€‰é¢˜</h4>
        <button class="close-btn" onclick="closeTopicModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="control-group">
          <label>é€‰é¢˜æ ‡é¢˜ *</label>
          <input type="text" id="new-topic-title" placeholder="è¾“å…¥é€‰é¢˜æ ‡é¢˜">
        </div>
        <div class="control-group">
          <label>å†…å®¹è‰ç¨¿ï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="new-topic-content" placeholder="å¯ä»¥å…ˆå†™ä¸€äº›å†…å®¹è‰ç¨¿"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTopicModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTopic()">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <!-- å›¾ç‰‡ç¼–è¾‘å¼¹çª— -->
  <div class="modal-overlay" id="image-editor-modal">
    <div class="modal image-editor">
      <div class="modal-header">
        <h4>ğŸ–¼ï¸ å›¾ç‰‡è®¾ç½®</h4>
        <button class="close-btn" onclick="closeImageEditor()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="img-preview-box">
          <img id="img-preview" src="" alt="é¢„è§ˆ">
        </div>
        <div class="img-settings">
          <div class="control-group">
            <label>å¯¹é½æ–¹å¼</label>
            <div class="btn-group">
              <button type="button" class="align-btn" data-value="left" onclick="setAlign('left')">â¬…ï¸ å·¦å¯¹é½</button>
              <button type="button" class="align-btn active" data-value="center" onclick="setAlign('center')">â†”ï¸ å±…ä¸­</button>
              <button type="button" class="align-btn" data-value="right" onclick="setAlign('right')">â¡ï¸ å³å¯¹é½</button>
            </div>
            <select id="img-align" style="display:none">
              <option value="left">å·¦å¯¹é½</option>
              <option value="center" selected>å±…ä¸­</option>
              <option value="right">å³å¯¹é½</option>
            </select>
          </div>
          <div class="control-group">
            <label>å›¾ç‰‡å¤§å°</label>
            <div class="size-options">
              <button type="button" class="size-btn" data-value="small" onclick="setSize('small')">
                <span class="size-icon">ğŸ”¹</span>
                <span>å°å›¾</span>
                <span class="size-hint">30%</span>
              </button>
              <button type="button" class="size-btn active" data-value="medium" onclick="setSize('medium')">
                <span class="size-icon">ğŸ”·</span>
                <span>ä¸­å›¾</span>
                <span class="size-hint">50%</span>
              </button>
              <button type="button" class="size-btn" data-value="large" onclick="setSize('large')">
                <span class="size-icon">ğŸ’</span>
                <span>å¤§å›¾</span>
                <span class="size-hint">75%</span>
              </button>
              <button type="button" class="size-btn" data-value="full" onclick="setSize('full')">
                <span class="size-icon">ğŸ“</span>
                <span>å…¨å®½</span>
                <span class="size-hint">100%</span>
              </button>
            </div>
            <select id="img-size" style="display:none">
              <option value="small">å° (30%)</option>
              <option value="medium" selected>ä¸­ (50%)</option>
              <option value="large">å¤§ (75%)</option>
              <option value="full">å…¨å®½ (100%)</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="deleteImage()">ğŸ—‘ï¸ åˆ é™¤å›¾ç‰‡</button>
        <button class="btn btn-primary" onclick="applyImageSettings()">âœ“ åº”ç”¨è®¾ç½®</button>
      </div>
    </div>
  </div>
  
  <!-- æ ‡ç­¾è¯åº“å¼¹çª— -->
  <div class="modal-overlay tags-modal" id="tags-modal">
    <div class="modal">
      <div class="modal-header">
        <h4>ğŸ·ï¸ æ ‡ç­¾è¯åº“</h4>
        <button class="close-btn" onclick="closeTagsModal()">Ã—</button>
      </div>
      <div class="modal-body" id="tags-body">
        <!-- æ ‡ç­¾åˆ†ç±»ä¼šåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="selected-tags">
        <div class="selected-tags-title">å·²é€‰æ ‡ç­¾ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰</div>
        <div class="selected-tags-content" id="selected-tags" onclick="copySelectedTags()"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="clearSelectedTags()">æ¸…ç©º</button>
        <button class="btn btn-primary" onclick="copySelectedTags()">ğŸ“‹ å¤åˆ¶æ ‡ç­¾</button>
      </div>
    </div>
  </div>
  
  <!-- æ¨æµæœºåˆ¶å¼¹çª— -->
  <div class="modal-overlay flow-modal" id="flow-modal">
    <div class="modal flow-modal-content">
      <div class="modal-header">
        <h4>ğŸ“ˆ å°çº¢ä¹¦æ¨æµæœºåˆ¶</h4>
        <button class="close-btn" onclick="closeFlowModal()">Ã—</button>
      </div>
      <div class="modal-body flow-body">
        <div class="flow-section">
          <div class="flow-section-title">â° æµé‡æ¨é€æ—¶é—´çº¿</div>
          <div class="flow-timeline">
            <div class="flow-item">
              <div class="flow-time">å‘å¸ƒå 2å°æ—¶</div>
              <div class="flow-desc">åˆå§‹æ›å…‰ï¼Œæ¨ç»™ç›®æ ‡ç¾¤ä½“</div>
              <div class="flow-tip">ğŸ’¡ é€‰å¯¹å‘å¸ƒæ—¶é—´ï¼šä¸Šåˆ10ç‚¹ / æ™šä¸Š10ç‚¹</div>
            </div>
            <div class="flow-item">
              <div class="flow-time">å‘å¸ƒå 24å°æ—¶</div>
              <div class="flow-desc">ä¼˜è´¨ç¬”è®°åŠ æƒï¼ˆCESç³»æ•°ï¼‰</div>
              <div class="flow-tip">ğŸ’¡ åŠæ—¶å›å¤è¯„è®ºï¼Œæå‡äº’åŠ¨</div>
            </div>
            <div class="flow-item">
              <div class="flow-time">å‘å¸ƒå 7å¤©</div>
              <div class="flow-desc">åˆ†æ°´å²­ï¼šæ•°æ®å¥½åŠ æƒï¼Œå·®å°±å‡‰</div>
              <div class="flow-tip">ğŸ’¡ å…³é”®æœŸï¼æŒç»­å…³æ³¨æ•°æ®</div>
            </div>
            <div class="flow-item">
              <div class="flow-time">å‘å¸ƒå 30å¤©</div>
              <div class="flow-desc">å…³é—­è‡ªç„¶æ¨æµï¼Œåªå‰©æœç´¢å±•ç¤º</div>
              <div class="flow-tip">ğŸ’¡ æ ‡é¢˜è¦æœ‰æœç´¢å…³é”®è¯</div>
            </div>
          </div>
        </div>
        
        <div class="flow-section">
          <div class="flow-section-title">ğŸ‘€ æµé‡æ± ç­‰çº§</div>
          <div class="flow-levels">
            <div class="flow-level level-1">
              <div class="level-range">1çº§ï¼š0-100</div>
              <div class="level-issue">å¯èƒ½è¿è§„æˆ–å†…å®¹å¤ªå·®</div>
            </div>
            <div class="flow-level level-2">
              <div class="level-range">2çº§ï¼š200-500</div>
              <div class="level-issue">æ ‡é¢˜å°é¢ä¸€èˆ¬ï¼Œéœ€ä¼˜åŒ–</div>
            </div>
            <div class="flow-level level-3">
              <div class="level-range">3çº§ï¼š3k-5k</div>
              <div class="level-issue">æœ‰å¹²è´§ä½†äº’åŠ¨ä¸€èˆ¬</div>
            </div>
            <div class="flow-level level-4">
              <div class="level-range">4çº§ï¼š1w-2w</div>
              <div class="level-issue">çƒ­é—¨å¤‡é€‰ï¼Œè¿›å…¥äººå·¥å®¡æ ¸</div>
            </div>
            <div class="flow-level level-5">
              <div class="level-range">5çº§ï¼š10w-20w</div>
              <div class="level-issue">çƒ­é—¨ç¬”è®°ï¼Œå†…å®¹æœ‰ç¨€ç¼ºæ€§</div>
            </div>
            <div class="flow-level level-6">
              <div class="level-range">6çº§ï¼š100w+</div>
              <div class="level-issue">å¤§çƒ­é—¨ï¼Œå¤´éƒ¨è¾¾äºº</div>
            </div>
          </div>
        </div>
        
        <div class="flow-section">
          <div class="flow-section-title">ğŸ“Š CESè¯„åˆ†å…¬å¼</div>
          <div class="ces-formula">
            <span class="ces-item">ç‚¹èµ Ã—1</span>
            <span class="ces-plus">+</span>
            <span class="ces-item">æ”¶è— Ã—1</span>
            <span class="ces-plus">+</span>
            <span class="ces-item highlight">è¯„è®º Ã—4</span>
            <span class="ces-plus">+</span>
            <span class="ces-item highlight">è½¬å‘ Ã—4</span>
          </div>
          <div class="ces-tip">è¯„è®ºå’Œè½¬å‘æƒé‡æœ€é«˜ï¼å¼•å¯¼ç”¨æˆ·è¯„è®ºå¾ˆé‡è¦</div>
        </div>
        
        <div class="flow-section">
          <div class="flow-section-title">âœ… å‘å¸ƒå‰æ£€æŸ¥æ¸…å•</div>
          <div class="checklist">
            <label class="check-item"><input type="checkbox"> æ ‡é¢˜æœ‰æœç´¢å…³é”®è¯</label>
            <label class="check-item"><input type="checkbox"> å°é¢å›¾æ¸…æ™°æœ‰å¸å¼•åŠ›</label>
            <label class="check-item"><input type="checkbox"> å†…å®¹æœ«å°¾æœ‰äº’åŠ¨å¼•å¯¼</label>
            <label class="check-item"><input type="checkbox"> å·²æ£€æµ‹è¿ç¦è¯</label>
            <label class="check-item"><input type="checkbox"> å‘å¸ƒæ—¶é—´ï¼šä¸Šåˆ10ç‚¹ / æ™šä¸Š10ç‚¹</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeFlowModal()">çŸ¥é“äº†</button>
      </div>
    </div>
  </div>
  
  <!-- åŠ è½½æç¤º -->
  <div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div>
  </div>
  
  <!-- å¤åˆ¶æˆåŠŸæç¤º -->
  <div class="toast" id="toast">âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

  <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
  <div class="controls">
    <div class="controls-header">
      <h2>ğŸ“ ç¬”è®°ç”Ÿæˆå™¨</h2>
      <div class="quick-actions">
        <a href="https://xhsplus.io/workspace#/3in1/sensitiveWords" target="_blank" class="quick-action" title="è¿ç¦è¯æ£€æµ‹">ğŸ”</a>
        <div class="quick-action" onclick="openTagsModal()" title="æ ‡ç­¾è¯åº“">ğŸ·ï¸</div>
        <div class="quick-action" onclick="openFlowModal()" title="æ¨æµæœºåˆ¶">ğŸ“ˆ</div>
        <a href="https://www.xiaohongshu.com/explore" target="_blank" class="quick-action" title="å°çº¢ä¹¦">ğŸ“±</a>
      </div>
    </div>
    
    <div class="control-group">
      <label>æ ‡é¢˜</label>
      <input type="text" id="memo-title" value="ç ”ç©¶ç”Ÿç¬¬ä¸€å¹´ï¼Œæˆ‘èµ°äº†å¤ªå¤šå¼¯è·¯" oninput="updatePreview()">
    </div>
    
    <div class="control-group">
      <label>å‰¯æ ‡é¢˜/ç³»åˆ—æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</label>
      <input type="text" id="memo-subtitle" value="è¯»ç ”é¿å‘æŒ‡å— 1" oninput="updatePreview()">
    </div>
    
    <div class="control-group">
      <label>æ­£æ–‡å†…å®¹ï¼ˆæ”¯æŒ **åŠ ç²—** ==é«˜äº®==ï¼‰</label>
      <button class="save-topic-btn" onclick="saveCurrentAsTopic()">ğŸ’¾ å­˜ä¸ºé€‰é¢˜</button>
      <textarea id="memo-content" oninput="updatePreview()">åˆšè¯»ç ”é‚£ä¼šå„¿ï¼Œæˆ‘çœŸçš„å¾ˆè¿·èŒ«ã€‚
å¯¼å¸ˆè®©æˆ‘"å…ˆçœ‹çœ‹æ–‡çŒ®"ï¼Œæˆ‘å°±çœŸçš„å‚»å‚»åœ°ä¸€ç¯‡ç¯‡å¾€ä¸‹çœ‹ï¼Œçœ‹äº†ä¸¤ä¸ªæœˆï¼Œå•¥ä¹Ÿæ²¡è®°ä½ã€‚åæ¥æ‰çŸ¥é“ï¼Œåº”è¯¥å…ˆçœ‹ç»¼è¿°ï¼Œå†é¡ºç€å¼•ç”¨å»æ‰¾å…³é”®çš„å‡ ç¯‡å°±å¤Ÿäº†ã€‚
ä»£ç ä¹Ÿæ˜¯ï¼Œä¸€å¼€å§‹æ€»æƒ³ç€è‡ªå·±ä»é›¶å†™ï¼Œç»“æœå†™äº†åˆ åˆ äº†å†™ï¼Œä¸€ä¸ªæœˆè¿‡å»äº†è¿baselineéƒ½æ²¡è·‘é€šã€‚åæ¥å­¦èªæ˜äº†ï¼Œç›´æ¥GitHubä¸Šæ‰¾å¼€æºä»£ç ï¼Œå…ˆè·‘é€šå†è¯´ï¼Œèƒ½æ”¹å°±æ”¹ï¼Œæ”¹ä¸äº†å°±åœ¨äººå®¶åŸºç¡€ä¸ŠåŠ ä¸œè¥¿ã€‚
æœ€è®©æˆ‘åæ‚”çš„æ˜¯ï¼Œç ”ä¸€æ•´æ•´ä¸€å¹´ï¼Œæˆ‘éƒ½æ²¡æ€ä¹ˆå’Œå¸ˆå…„å¸ˆå§äº¤æµã€‚æ€»è§‰å¾—è‡ªå·±å•¥ä¹Ÿä¸ä¼šï¼Œé—®é—®é¢˜å¾ˆä¸¢äººã€‚ç»“æœå¾ˆå¤šå‘äººå®¶æ—©å°±è¸©è¿‡äº†ï¼Œæˆ‘åˆé‡æ–°è¸©äº†ä¸€éã€‚
ç°åœ¨å›å¤´çœ‹ï¼Œç ”ä¸€æœ€è¯¥åšçš„å‡ ä»¶äº‹ï¼š
**1. åˆ«é—·å¤´çœ‹æ–‡çŒ®ï¼Œè¦å¸¦ç€é—®é¢˜çœ‹**
å…ˆææ¸…æ¥šè¿™ä¸ªé¢†åŸŸåœ¨è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œæœ‰å“ªäº›ä¸»æµæ–¹æ³•ï¼Œå†å»çœ‹å…·ä½“çš„è®ºæ–‡ã€‚æ¼«æ— ç›®çš„åœ°çœ‹ï¼Œçœ‹å†å¤šä¹Ÿæ˜¯ç™½çœ‹ã€‚
**2. ä»£ç èƒ½è·‘é€šæ¯”å†™å¾—æ¼‚äº®é‡è¦**
å…ˆå¤ç°ï¼Œå†ä¼˜åŒ–ã€‚åˆ«ä¸€ä¸Šæ¥å°±æƒ³åšåˆ°æœ€å¥½ï¼Œé‚£æ ·æ°¸è¿œå¼€å§‹ä¸äº†ã€‚
**3. å¤šé—®ï¼Œå¤šäº¤æµ**
å¸ˆå…„å¸ˆå§ã€å¯¼å¸ˆã€åŒå­¦ï¼Œç½‘ä¸Šçš„åšä¸»ï¼Œèƒ½é—®å°±é—®ã€‚é—·å¤´åšåªä¼šè¶Šåšè¶Šæ…¢ã€‚
**4. æ—©ç‚¹ç¡®å®šæ–¹å‘**
åˆ«ä»€ä¹ˆéƒ½æƒ³å­¦ï¼ŒæŒ‘ä¸€ä¸ªå°æ–¹å‘æ·±æŒ–ï¼Œæ¯”ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­å¼ºå¤ªå¤šã€‚
**5. å­¦ä¼šç®¡ç†æ–‡çŒ®å’Œä»£ç **
Zoteroç®¡æ–‡çŒ®ï¼ŒGitHubç®¡ä»£ç ï¼ŒNotionè®°ç¬”è®°ã€‚
==å¸Œæœ›çœ‹åˆ°è¿™ç¯‡çš„ä½ ï¼Œåˆ«å†è¸©æˆ‘è¸©è¿‡çš„å‘äº†ã€‚==
æœ‰é—®é¢˜è¯„è®ºåŒºé—®æˆ‘ï¼Œçœ‹åˆ°éƒ½ä¼šå›ğŸ‘‡</textarea>
    </div>
    
    <div class="page-info" id="page-info">ğŸ“„ å…± 1 é¡µ</div>
    
    <div class="btn-row">
      <button class="btn btn-primary" onclick="downloadAllPages()">ğŸ“¥ ä¸‹è½½å…¨éƒ¨</button>
      <button class="btn btn-secondary" onclick="downloadCurrentPage()">ğŸ“„ å½“å‰é¡µ</button>
    </div>
    
    <div class="tips">
      <strong>æ ¼å¼ï¼š</strong> ã€æ ‡é¢˜ã€‘ â€¢ åˆ—è¡¨ â‘ åºå· **åŠ ç²—** ==é«˜äº®==<br>
      <strong>å›¾ç‰‡ï¼š</strong> æ‹–æ‹½/ç²˜è´´æ’å…¥ï¼Œç‚¹å‡»ç¼–è¾‘
    </div>
  </div>
  
  <!-- å³ä¾§é¢„è§ˆåŒº -->
  <div class="preview-area" id="preview-container">
    <!-- ä¸»é¢˜åˆ‡æ¢æ”¾åœ¨é¢„è§ˆåŒºä¸Šæ–¹ -->
    <div class="theme-switcher">
      <button class="theme-btn active" data-theme="memo" onclick="switchTheme('memo')">
        <span class="theme-icon">ğŸ“’</span>
        <span>å¤‡å¿˜å½•</span>
      </button>
      <button class="theme-btn" data-theme="zhihu" onclick="switchTheme('zhihu')">
        <span class="theme-icon">ğŸ’¬</span>
        <span>çŸ¥ä¹</span>
      </button>
      <button class="theme-btn" data-theme="dark" onclick="switchTheme('dark')">
        <span class="theme-icon">ğŸŒ™</span>
        <span>æš—é»‘</span>
      </button>
    </div>
    
    <div class="preview-header">
      <span class="preview-title">é¢„è§ˆ</span>
      <div class="page-nav">
        <button onclick="prevPage()" id="btn-prev" disabled>â€¹</button>
        <span class="page-num" id="page-display">1 / 1</span>
        <button onclick="nextPage()" id="btn-next" disabled>â€º</button>
      </div>
    </div>
    <div class="pages-container" id="pages-container"></div>
  </div>
  
  <div class="export-container" id="export-container"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  
  <script>
    // ========== æ•°æ®å­˜å‚¨ ==========
    const TOPICS_KEY = 'xhs_topics_v3';
    const HISTORY_KEY = 'xhs_history_v1';
    const MAX_HISTORY = 50;
    
    // æ ‡ç­¾è¯åº“æ•°æ®
    const TAG_CATEGORIES = [
      {
        name: 'ğŸ“ è€ƒç ”/ä¿ç ”',
        tags: ['è€ƒç ”', 'ä¿ç ”', 'è€ƒç ”å¤è¯•', 'ä¿ç ”é¢è¯•', 'æ¨å…', 'è€ƒç ”è‹±è¯­', 'è€ƒç ”æ•°å­¦', 'è€ƒç ”æ”¿æ²»', 'è·¨ä¸“ä¸šè€ƒç ”', 'äºŒæˆ˜è€ƒç ”', 'è°ƒå‰‚']
      },
      {
        name: 'ğŸ“š ç ”ç©¶ç”Ÿ/ç§‘ç ”',
        tags: ['ç ”ç©¶ç”Ÿ', 'è¯»ç ”', 'ç§‘ç ”', 'ç ”ä¸€', 'ç ”äºŒ', 'ç ”ä¸‰', 'ç¡•å£«', 'åšå£«', 'å¯¼å¸ˆ', 'è®ºæ–‡', 'å¼€é¢˜', 'æ¯•ä¸šè®ºæ–‡', 'ç§‘ç ”å°ç™½']
      },
      {
        name: 'ğŸ¤– AI/ç¼–ç¨‹',
        tags: ['æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'Python', 'äººå·¥æ™ºèƒ½', 'AI', 'ä»£ç ', 'ç¼–ç¨‹', 'ChatGPT', 'å¤§æ¨¡å‹', 'PyTorch', 'æ•°æ®åˆ†æ', 'CV', 'NLP']
      },
      {
        name: 'ğŸ’¡ å¹²è´§/å­¦ä¹ ',
        tags: ['å¹²è´§', 'å»ºè®®æ”¶è—', 'å­¦ä¹ æ–¹æ³•', 'é¿å‘', 'ç»éªŒåˆ†äº«', 'å­¦ä¹ ', 'è‡ªå¾‹', 'æ—¶é—´ç®¡ç†', 'æ•ˆç‡', 'å·¥å…·æ¨è']
      },
      {
        name: 'ğŸ˜„ æ—¥å¸¸/æƒ…æ„Ÿ',
        tags: ['ç ”ç©¶ç”Ÿæ—¥å¸¸', 'ç§‘ç ”æ—¥å¸¸', 'è¯»ç ”ç”Ÿæ´»', 'ç²¾ç¥çŠ¶æ€', 'emo', 'å´©æºƒ', 'åŠ æ²¹', 'æ­£èƒ½é‡']
      }
    ];
    
    let selectedTags = [];
    let currentPage = 0;
    let totalPages = 1;
    let pagesData = [];
    
    // ========== å­˜å‚¨å‡½æ•° ==========
    const NOTES_KEY = 'xhs_notes_v1';
    const BACKUP_FILE = 'xhs_backup.json';
    
    function getTopics() {
      return JSON.parse(localStorage.getItem(TOPICS_KEY) || '[]');
    }
    function saveTopicsData(topics) {
      localStorage.setItem(TOPICS_KEY, JSON.stringify(topics));
      scheduleBackup();
    }
    function getHistory() {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    }
    function saveHistoryData(history) {
      // é™åˆ¶æœ€å¤š50æ¡
      if (history.length > MAX_HISTORY) {
        history = history.slice(0, MAX_HISTORY);
      }
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
      scheduleBackup();
    }
    function getNotes() {
      return JSON.parse(localStorage.getItem(NOTES_KEY) || '[]');
    }
    function saveNotesData(notes) {
      localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
      scheduleBackup();
    }
    
    // ========== å¤‡ä»½åŠŸèƒ½ ==========
    let backupTimer = null;
    let lastBackupData = '';
    let backupFileHandle = null; // ä¿å­˜æ–‡ä»¶å¥æŸ„ï¼Œç”¨äºè‡ªåŠ¨ä¿å­˜
    
    function scheduleBackup() {
      // é˜²æŠ–ï¼š2ç§’å†…å¤šæ¬¡ä¿®æ”¹åªå¤‡ä»½ä¸€æ¬¡
      if (backupTimer) clearTimeout(backupTimer);
      backupTimer = setTimeout(autoBackup, 2000);
    }
    
    async function autoBackup() {
      const data = {
        version: 1,
        exportTime: new Date().toISOString(),
        topics: getTopics(),
        notes: getNotes(),
        history: getHistory()
      };
      const dataStr = JSON.stringify(data, null, 2);
      
      // æ•°æ®æ²¡å˜åŒ–å°±ä¸å¤‡ä»½
      if (dataStr === lastBackupData) return;
      lastBackupData = dataStr;
      
      // ä¿å­˜åˆ°localStorageçš„å¤‡ä»½å‰¯æœ¬
      localStorage.setItem('xhs_backup_data', dataStr);
      localStorage.setItem('xhs_backup_time', new Date().toLocaleString());
      
      // å¦‚æœå·²è®¾ç½®å¤‡ä»½æ–‡ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
      if (backupFileHandle) {
        try {
          const writable = await backupFileHandle.createWritable();
          await writable.write(dataStr);
          await writable.close();
          console.log('è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶æˆåŠŸ');
        } catch (e) {
          console.warn('è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œæ–‡ä»¶å¥æŸ„å¯èƒ½å·²å¤±æ•ˆ', e);
          backupFileHandle = null;
          updateBackupStatus();
        }
      }
      
      updateBackupStatus();
    }
    
    function updateBackupStatus() {
      const time = localStorage.getItem('xhs_backup_time');
      const el = document.getElementById('backup-status');
      if (el) {
        if (backupFileHandle) {
          el.innerHTML = `âœ… è‡ªåŠ¨ä¿å­˜å·²å¼€å¯<br><small style="opacity:0.6">${time || ''}</small>`;
          el.style.color = '#4caf50';
        } else if (time) {
          el.innerHTML = `ä¸Šæ¬¡ä¿å­˜: ${time}<br><small style="opacity:0.6">ç‚¹å‡»ä¸‹æ–¹è®¾ç½®è‡ªåŠ¨ä¿å­˜</small>`;
          el.style.color = '';
        }
      }
    }
    
    // è®¾ç½®è‡ªåŠ¨ä¿å­˜è·¯å¾„
    async function setupAutoSave() {
      if (!('showSaveFilePicker' in window)) {
        alert('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome æˆ– Edge');
        return;
      }
      
      try {
        // è®©ç”¨æˆ·é€‰æ‹©ä¿å­˜ä½ç½®
        backupFileHandle = await window.showSaveFilePicker({
          suggestedName: 'xhs_backup.json',
          types: [{
            description: 'å¤‡ä»½æ–‡ä»¶',
            accept: { 'application/json': ['.json'] }
          }]
        });
        
        // ç«‹å³ä¿å­˜ä¸€æ¬¡
        await autoBackup();
        showToast('è‡ªåŠ¨ä¿å­˜å·²è®¾ç½®ï¼æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¯¥æ–‡ä»¶');
        updateBackupStatus();
      } catch (e) {
        if (e.name !== 'AbortError') {
          console.error(e);
          alert('è®¾ç½®å¤±è´¥: ' + e.message);
        }
      }
    }
    
    function exportBackup() {
      const data = {
        version: 1,
        exportTime: new Date().toISOString(),
        topics: getTopics(),
        notes: getNotes(),
        history: getHistory()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `å°çº¢ä¹¦æ•°æ®å¤‡ä»½_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('å¤‡ä»½æ–‡ä»¶å·²ä¸‹è½½');
    }
    
    function importBackup() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            
            if (!data.topics && !data.notes && !data.history) {
              alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶');
              return;
            }
            
            const topicCount = data.topics?.length || 0;
            const noteCount = data.notes?.length || 0;
            const historyCount = data.history?.length || 0;
            
            if (!confirm(`ç¡®è®¤å¯¼å…¥ï¼Ÿ\n\né€‰é¢˜: ${topicCount} æ¡\nå¿ƒå¾—: ${noteCount} æ¡\nå†å²: ${historyCount} æ¡\n\nâš ï¸ è¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼`)) {
              return;
            }
            
            if (data.topics) localStorage.setItem(TOPICS_KEY, JSON.stringify(data.topics));
            if (data.notes) localStorage.setItem(NOTES_KEY, JSON.stringify(data.notes));
            if (data.history) localStorage.setItem(HISTORY_KEY, JSON.stringify(data.history));
            
            renderTopics();
            renderNotes();
            renderHistory();
            showToast('æ•°æ®å·²æ¢å¤');
          } catch (err) {
            alert('æ–‡ä»¶è§£æå¤±è´¥: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    // ========== ä¾§è¾¹æ  ==========
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('show');
      document.getElementById('sidebar-overlay').classList.toggle('show');
      renderTopics();
      renderNotes();
      renderHistory();
    }
    
    function switchTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.sidebar-tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      
      if (tab === 'history') renderHistory();
      else if (tab === 'notes') renderNotes();
      else renderTopics();
    }
    
    // ========== é€‰é¢˜åº“ ==========
    function openNewTopicModal() {
      document.getElementById('topic-modal').classList.add('show');
      document.getElementById('new-topic-title').value = '';
      document.getElementById('new-topic-content').value = '';
      document.getElementById('new-topic-title').focus();
    }
    
    function closeTopicModal() {
      document.getElementById('topic-modal').classList.remove('show');
    }
    
    function saveTopic() {
      const title = document.getElementById('new-topic-title').value.trim();
      const content = document.getElementById('new-topic-content').value.trim();
      if (!title) { alert('è¯·è¾“å…¥é€‰é¢˜æ ‡é¢˜'); return; }
      
      const topics = getTopics();
      topics.unshift({ id: Date.now(), title, content, createdAt: Date.now() });
      saveTopicsData(topics);
      renderTopics();
      closeTopicModal();
    }
    
    function saveCurrentAsTopic() {
      const title = document.getElementById('memo-title').value.trim();
      const content = document.getElementById('memo-content').value.trim();
      if (!title) { alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜'); return; }
      
      const topics = getTopics();
      topics.unshift({ id: Date.now(), title, content, createdAt: Date.now() });
      saveTopicsData(topics);
      showToast('å·²ä¿å­˜åˆ°é€‰é¢˜åº“');
      renderTopics();
    }
    
    function useTopic(id) {
      const topics = getTopics();
      const topic = topics.find(t => t.id === id);
      if (topic) {
        document.getElementById('memo-title').value = topic.title;
        if (topic.content) document.getElementById('memo-content').value = topic.content;
        updatePreview();
        toggleSidebar();
      }
    }
    
    function archiveTopic(id) {
      const topics = getTopics();
      const index = topics.findIndex(t => t.id === id);
      if (index > -1) {
        const topic = topics[index];
        // ç§»åˆ°å†å²è®°å½•
        const history = getHistory();
        history.unshift({
          id: Date.now(),
          title: topic.title,
          content: topic.content,
          archivedAt: Date.now()
        });
        saveHistoryData(history);
        // ä»é€‰é¢˜åº“åˆ é™¤
        topics.splice(index, 1);
        saveTopicsData(topics);
        renderTopics();
        showToast('å·²ç§»è‡³å†å²è®°å½•');
      }
    }
    
    function deleteTopic(id) {
      if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      const topics = getTopics();
      const index = topics.findIndex(t => t.id === id);
      if (index > -1) {
        topics.splice(index, 1);
        saveTopicsData(topics);
        renderTopics();
      }
    }
    
    function renderTopics() {
      const topics = getTopics();
      const el = document.getElementById('topic-list');
      
      if (topics.length === 0) {
        el.innerHTML = '<div class="topic-empty"><div class="topic-empty-icon">ğŸ“</div><div class="topic-empty-text">æš‚æ— é€‰é¢˜</div></div>';
        return;
      }
      
      el.innerHTML = topics.map(t => `
        <div class="topic-card">
          <div class="topic-card-header">
            <div class="topic-card-title" onclick="useTopic(${t.id})">${t.title}</div>
            <div class="topic-card-actions">
              <button class="use-btn" onclick="useTopic(${t.id})" title="ä½¿ç”¨">âœ“</button>
              <button class="archive-btn" onclick="archiveTopic(${t.id})" title="æ ‡è®°å·²ç”¨">ğŸ“</button>
              <button class="delete-btn" onclick="deleteTopic(${t.id})" title="åˆ é™¤">Ã—</button>
            </div>
          </div>
          ${t.content ? `<div class="topic-card-content">${t.content.substring(0, 80)}...</div>` : ''}
          <div class="topic-card-meta">
            <span class="topic-card-date">${formatDate(t.createdAt)}</span>
          </div>
        </div>
      `).join('');
    }
    
    // ========== å†™ä½œå¿ƒå¾— ==========
    const NOTE_TYPES = {
      success: { icon: 'âœ…', label: 'æˆåŠŸç»éªŒ', color: '#4caf50' },
      fail: { icon: 'âŒ', label: 'è¸©å‘æ•™è®­', color: '#f44336' },
      idea: { icon: 'ğŸ’¡', label: 'çµæ„Ÿæƒ³æ³•', color: '#ff9800' },
      data: { icon: 'ğŸ“Š', label: 'æ•°æ®å¤ç›˜', color: '#2196f3' }
    };
    
    let editingNoteId = null; // æ­£åœ¨ç¼–è¾‘çš„å¿ƒå¾—ID
    
    function openNewNoteModal() {
      editingNoteId = null;
      document.getElementById('note-modal-title').textContent = 'ğŸ’¡ è®°å½•å¿ƒå¾—';
      document.getElementById('note-type').value = 'success';
      document.getElementById('note-content').value = '';
      document.getElementById('note-modal').classList.add('show');
      document.getElementById('note-content').focus();
    }
    
    function editNote(id) {
      const notes = getNotes();
      const note = notes.find(n => n.id === id);
      if (!note) return;
      
      editingNoteId = id;
      document.getElementById('note-modal-title').textContent = 'âœï¸ ç¼–è¾‘å¿ƒå¾—';
      document.getElementById('note-type').value = note.type;
      document.getElementById('note-content').value = note.content;
      document.getElementById('note-modal').classList.add('show');
      document.getElementById('note-content').focus();
    }
    
    function closeNoteModal() {
      document.getElementById('note-modal').classList.remove('show');
      editingNoteId = null;
    }
    
    function saveNote() {
      const type = document.getElementById('note-type').value;
      const content = document.getElementById('note-content').value.trim();
      if (!content) { alert('è¯·è¾“å…¥å¿ƒå¾—å†…å®¹'); return; }
      
      const notes = getNotes();
      
      if (editingNoteId) {
        // ç¼–è¾‘æ¨¡å¼
        const index = notes.findIndex(n => n.id === editingNoteId);
        if (index > -1) {
          notes[index].type = type;
          notes[index].content = content;
          notes[index].updatedAt = Date.now();
        }
        showToast('å¿ƒå¾—å·²æ›´æ–°');
      } else {
        // æ–°å»ºæ¨¡å¼
        notes.unshift({ id: Date.now(), type, content, createdAt: Date.now() });
        showToast('å¿ƒå¾—å·²ä¿å­˜');
      }
      
      saveNotesData(notes);
      renderNotes();
      closeNoteModal();
    }
    
    function deleteNote(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡å¿ƒå¾—ï¼Ÿ')) return;
      const notes = getNotes();
      const index = notes.findIndex(n => n.id === id);
      if (index > -1) {
        notes.splice(index, 1);
        saveNotesData(notes);
        renderNotes();
      }
    }
    
    function renderNotes() {
      const notes = getNotes();
      const el = document.getElementById('notes-list');
      
      if (notes.length === 0) {
        el.innerHTML = '<div class="topic-empty"><div class="topic-empty-icon">ğŸ’¡</div><div class="topic-empty-text">æš‚æ— å¿ƒå¾—<br><small style="opacity:0.5">è®°å½•ä½ çš„è¿è¥ç»éªŒå’Œæ•™è®­</small></div></div>';
        return;
      }
      
      el.innerHTML = notes.map(n => {
        const typeInfo = NOTE_TYPES[n.type] || NOTE_TYPES.idea;
        return `
          <div class="topic-card note-card" style="border-left: 3px solid ${typeInfo.color}">
            <div class="topic-card-header">
              <div class="note-type-badge" style="background: ${typeInfo.color}">${typeInfo.icon} ${typeInfo.label}</div>
              <div class="topic-card-actions">
                <button class="edit-btn" onclick="editNote(${n.id})" title="ç¼–è¾‘">âœï¸</button>
                <button class="delete-btn" onclick="deleteNote(${n.id})" title="åˆ é™¤">Ã—</button>
              </div>
            </div>
            <div class="note-card-content">${n.content}</div>
            <div class="topic-card-meta">
              <span class="topic-card-date">${formatDate(n.createdAt)}${n.updatedAt ? ' (å·²ç¼–è¾‘)' : ''}</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ========== å†å²è®°å½• ==========
    function renderHistory() {
      const history = getHistory();
      const el = document.getElementById('history-list');
      
      if (history.length === 0) {
        el.innerHTML = '<div class="topic-empty"><div class="topic-empty-icon">ğŸ“œ</div><div class="topic-empty-text">æš‚æ— å†å²è®°å½•<br><small style="opacity:0.5">é€‰é¢˜æ ‡è®°å·²ç”¨åä¼šå‡ºç°åœ¨è¿™é‡Œ</small></div></div>';
        return;
      }
      
      el.innerHTML = history.map(h => `
        <div class="topic-card">
          <div class="topic-card-header">
            <div class="topic-card-title" onclick="useHistory(${h.id})">${h.title}</div>
            <div class="topic-card-actions">
              <button class="use-btn" onclick="useHistory(${h.id})" title="å†æ¬¡ä½¿ç”¨">â†º</button>
              <button class="delete-btn" onclick="deleteHistory(${h.id})" title="åˆ é™¤">Ã—</button>
            </div>
          </div>
          ${h.content ? `<div class="topic-card-content">${h.content.substring(0, 80)}...</div>` : ''}
          <div class="topic-card-meta">
            <span class="topic-card-date">${formatDate(h.archivedAt)}</span>
          </div>
        </div>
      `).join('');
    }
    
    function useHistory(id) {
      const history = getHistory();
      const item = history.find(h => h.id === id);
      if (item) {
        document.getElementById('memo-title').value = item.title;
        if (item.content) document.getElementById('memo-content').value = item.content;
        updatePreview();
        toggleSidebar();
      }
    }
    
    function deleteHistory(id) {
      if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      const history = getHistory();
      const index = history.findIndex(h => h.id === id);
      if (index > -1) {
        history.splice(index, 1);
        saveHistoryData(history);
        renderHistory();
      }
    }
    
    // ========== æ¨æµæœºåˆ¶å¼¹çª— ==========
    function openFlowModal() {
      document.getElementById('flow-modal').classList.add('show');
    }
    function closeFlowModal() {
      document.getElementById('flow-modal').classList.remove('show');
    }
    
    // ========== æ ‡ç­¾è¯åº“ ==========
    function openTagsModal() {
      selectedTags = [];
      renderTagsModal();
      document.getElementById('tags-modal').classList.add('show');
    }
    
    function closeTagsModal() {
      document.getElementById('tags-modal').classList.remove('show');
    }
    
    function renderTagsModal() {
      const body = document.getElementById('tags-body');
      body.innerHTML = TAG_CATEGORIES.map(cat => `
        <div class="tag-category">
          <div class="tag-category-title">${cat.name}</div>
          <div class="tag-list">
            ${cat.tags.map(tag => `
              <div class="tag-item ${selectedTags.includes(tag) ? 'selected' : ''}" onclick="toggleTag('${tag}')">#${tag}</div>
            `).join('')}
          </div>
        </div>
      `).join('');
      
      document.getElementById('selected-tags').textContent = selectedTags.map(t => '#' + t).join(' ');
    }
    
    function toggleTag(tag) {
      const index = selectedTags.indexOf(tag);
      if (index > -1) {
        selectedTags.splice(index, 1);
      } else {
        selectedTags.push(tag);
      }
      renderTagsModal();
    }
    
    function clearSelectedTags() {
      selectedTags = [];
      renderTagsModal();
    }
    
    function copySelectedTags() {
      if (selectedTags.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ ‡ç­¾');
        return;
      }
      const text = selectedTags.map(t => '#' + t).join(' ');
      navigator.clipboard.writeText(text).then(() => {
        showToast('å·²å¤åˆ¶ï¼š' + text);
      });
    }
    
    // ========== å·¥å…·å‡½æ•° ==========
    function formatDate(ts) {
      const d = new Date(ts);
      return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
    }
    
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = 'âœ“ ' + msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
    
    // ========== ç¬”è®°ç”Ÿæˆ ==========
    function parseContent(text) {
      const lines = text.split('\n');
      const result = [];
      let tableBuffer = [];
      let inTable = false;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();
        
        // æ£€æµ‹æ˜¯å¦æ˜¯è¡¨æ ¼è¡Œ
        const isTableRow = /^\|.+\|$/.test(trimmed);
        const isSeparator = /^\|[-:\s|]+\|$/.test(trimmed);
        
        if (isTableRow || isSeparator) {
          if (!isSeparator) {
            tableBuffer.push(trimmed);
          }
          inTable = true;
          continue;
        }
        
        // å¦‚æœåˆšç»“æŸè¡¨æ ¼
        if (inTable && tableBuffer.length > 0) {
          result.push(buildTable(tableBuffer));
          tableBuffer = [];
          inTable = false;
        }
        
        // å¤„ç†æ™®é€šè¡Œ
        result.push(parseLine(line));
      }
      
      // å¤„ç†æœ«å°¾çš„è¡¨æ ¼
      if (tableBuffer.length > 0) {
        result.push(buildTable(tableBuffer));
      }
      
      return result.join('');
    }
    
    // å•è¡Œè§£æ
    function parseLine(line) {
      const html = line;
      const trimmed = html.trim();
      
      // ç©ºè¡Œ
      if (!trimmed) {
        return `<div class="text-line empty"></div>`;
      }
      
      // å›¾ç‰‡ ![alt|align|size](imgId) æˆ– ![alt](url)
      if (/^!\[.*?\]\(.+?\)$/.test(trimmed)) {
        const match = trimmed.match(/^!\[(.*?)\]\((.+?)\)$/);
        if (match) {
          const params = match[1].split('|');
          const alt = params[0] || 'å›¾ç‰‡';
          const align = params.find(p => ['left', 'center', 'right'].includes(p)) || 'center';
          const size = params.find(p => ['small', 'medium', 'large', 'full'].includes(p)) || 'medium';
          const src = match[2];
          // æ£€æŸ¥æ˜¯å¦æ˜¯å†…éƒ¨å­˜å‚¨çš„å›¾ç‰‡
          const imgSrc = imageStore[src] || src;
          return `<div class="image-container align-${align}"><img src="${imgSrc}" alt="${alt}" class="memo-image size-${size}" data-imgid="${src}" onclick="openImageEditor('${src}')"></div>`;
        }
      }
      
      // ã€å°æ ‡é¢˜ã€‘ â†’ å¸¦èƒŒæ™¯çš„æ ‡é¢˜å—
      if (/^ã€[^ï¼š]+ã€‘$/.test(trimmed)) {
        const title = trimmed.slice(1, -1);
        return `<div class="section-title">${title}</div>`;
      }
      
      // ã€xxxï¼šå†…å®¹ã€‘ â†’ å¸¦æ ‡ç­¾çš„æ ‡é¢˜
      if (/^ã€.+ï¼š.+ã€‘$/.test(trimmed)) {
        const match = trimmed.match(/^ã€(.+?)ï¼š(.+)ã€‘$/);
        if (match) {
          return `<div class="section-title"><span class="section-label">${match[1]}</span>${match[2]}</div>`;
        }
      }
      
      // â–¸ æˆ– â–¶ å¼€å¤´ â†’ å¼ºè°ƒåˆ—è¡¨é¡¹
      if (/^[â–¸â–¶â–º]/.test(trimmed)) {
        const content = trimmed.slice(1).trim();
        return `<div class="list-item accent"><span class="list-dot">â–¸</span>${parseInline(content)}</div>`;
      }
      
      // â€¢ å¼€å¤´ â†’ åˆ—è¡¨é¡¹
      if (/^[â€¢Â·]/.test(trimmed)) {
        const content = trimmed.slice(1).trim();
        return `<div class="list-item"><span class="list-dot">â€¢</span>${parseInline(content)}</div>`;
      }
      
      // âœ“ âœ” â˜‘ å¼€å¤´ â†’ å®Œæˆé¡¹
      if (/^[âœ“âœ”â˜‘]/.test(trimmed)) {
        const content = trimmed.slice(1).trim();
        return `<div class="list-item check"><span class="list-dot">âœ“</span>${parseInline(content)}</div>`;
      }
      
      // âœ— âœ˜ â˜’ X å¼€å¤´ â†’ é”™è¯¯é¡¹
      if (/^[âœ—âœ˜â˜’âœ•X]/.test(trimmed) && !/^XG/.test(trimmed)) {
        const content = trimmed.slice(1).trim();
        return `<div class="list-item cross"><span class="list-dot">âœ—</span>${parseInline(content)}</div>`;
      }
      
      // ğŸ”¥ â­ ğŸ’¡ ç­‰emojiå¼€å¤´ â†’ å›¾æ ‡è¡Œ
      if (/^[\u{1F300}-\u{1F9FF}]/u.test(trimmed)) {
        return `<div class="icon-line">${parseInline(trimmed)}</div>`;
      }
      
      // --- æˆ– === åˆ†å‰²çº¿
      if (/^[-=]{3,}$/.test(trimmed)) {
        return `<div class="divider"></div>`;
      }
      
      // > å¼•ç”¨å—
      if (/^>/.test(trimmed)) {
        const content = trimmed.slice(1).trim();
        return `<div class="quote-block">${parseInline(content)}</div>`;
      }
      
      // æ•°å­—åºå·å¼€å¤´ â‘ â‘¡â‘¢ æˆ– 1. 2. 3.
      if (/^[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©]/.test(trimmed)) {
        const num = trimmed[0];
        const content = trimmed.slice(1).trim();
        return `<div class="step-item"><span class="step-num">${num}</span>${parseInline(content)}</div>`;
      }
      if (/^\d+[.ã€]/.test(trimmed)) {
        const match = trimmed.match(/^(\d+)[.ã€]\s*(.*)$/);
        if (match) {
          const circleNums = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨','â‘©'];
          const num = circleNums[parseInt(match[1]) - 1] || match[1];
          return `<div class="step-item"><span class="step-num">${num}</span>${parseInline(match[2])}</div>`;
        }
      }
      
      // æ™®é€šè¡Œ
      return `<div class="text-line">${parseInline(html)}</div>`;
    }
    
    // æ„å»ºè¡¨æ ¼HTML
    function buildTable(lines) {
      if (lines.length === 0) return '';
      
      let html = '<div class="table-wrapper"><table class="memo-table">';
      
      lines.forEach((line, idx) => {
        const cells = line.split('|').filter(c => c !== '');
        const tag = idx === 0 ? 'th' : 'td';
        const rowClass = idx === 0 ? 'header' : (idx % 2 === 0 ? 'even' : 'odd');
        
        html += `<tr class="${rowClass}">`;
        cells.forEach(cell => {
          html += `<${tag}>${parseInline(cell.trim())}</${tag}>`;
        });
        html += '</tr>';
      });
      
      html += '</table></div>';
      return html;
    }
    
    // è¡Œå†…æ ¼å¼è§£æ
    function parseInline(text) {
      let html = text;
      // **åŠ ç²—**
      html = html.replace(/\*\*([^*]+)\*\*/g, '<span class="bold">$1</span>');
      // ==é«˜äº®==
      html = html.replace(/==([^=]+)==/g, '<span class="highlight">$1</span>');
      // ~~åˆ é™¤çº¿~~
      html = html.replace(/~~([^~]+)~~/g, '<span class="strikethrough">$1</span>');
      // `ä»£ç `
      html = html.replace(/`([^`]+)`/g, '<span class="code-inline">$1</span>');
      // ã€Œå¼•ç”¨ã€
      html = html.replace(/ã€Œ([^ã€]+)ã€/g, '<span class="quote-text">$1</span>');
      // ã€é‡ç‚¹ã€
      html = html.replace(/ã€([^ã€]+)ã€/g, '<span class="emphasis-box">$1</span>');
      // â†’ç®­å¤´
      html = html.replace(/â†’/g, '<span class="arrow">â†’</span>');
      // å†’å·åå†…å®¹ï¼ˆç”¨äº è¾“å…¥ï¼šxxx è¿™ç§æ ¼å¼ï¼‰
      html = html.replace(/^([\u4e00-\u9fa5]+)ï¼š/g, '<span class="label">$1ï¼š</span>');
      return html;
    }
    
    // ========== å›¾ç‰‡æ‹–æ‹½åŠŸèƒ½ ==========
    const imageStore = {}; // å­˜å‚¨å›¾ç‰‡ base64
    
    function setupImageDrag() {
      const textarea = document.getElementById('memo-content');
      
      textarea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        textarea.classList.add('drag-over');
      });
      
      textarea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        textarea.classList.remove('drag-over');
      });
      
      textarea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        textarea.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length === 0) return;
        
        for (let file of files) {
          if (file.type.startsWith('image/')) {
            handleImageFile(file, textarea);
          }
        }
      });
      
      // æ”¯æŒç²˜è´´å›¾ç‰‡å’Œæ–‡æœ¬
      textarea.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        let hasImage = false;
        for (let item of items) {
          if (item.type.startsWith('image/')) {
            e.preventDefault();
            const file = item.getAsFile();
            handleImageFile(file, textarea);
            hasImage = true;
            break;
          }
        }
        // ç²˜è´´æ–‡æœ¬æ—¶ï¼Œå»¶è¿Ÿé‡ç½®åˆ°ç¬¬ä¸€é¡µ
        if (!hasImage) {
          setTimeout(() => {
            updatePreview(true); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
          }, 10);
        }
      });
    }
    
    function handleImageFile(file, textarea) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result;
        const imgId = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        imageStore[imgId] = base64;
        
        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡æ ‡è®°ï¼Œé»˜è®¤ä¸­ç­‰å¤§å°å±…ä¸­
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);
        const imgTag = `\n![å›¾ç‰‡|center|medium](${imgId})\n`;
        
        textarea.value = textBefore + imgTag + textAfter;
        textarea.selectionStart = textarea.selectionEnd = cursorPos + imgTag.length;
        textarea.focus();
        
        updatePreview();
        showToast('å›¾ç‰‡å·²æ’å…¥ï¼Œç‚¹å‡»å›¾ç‰‡å¯ç¼–è¾‘');
      };
      reader.readAsDataURL(file);
    }
    
    // å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½
    let currentEditingImgId = null;
    
    function openImageEditor(imgId) {
      currentEditingImgId = imgId;
      const textarea = document.getElementById('memo-content');
      const content = textarea.value;
      
      // è§£æå½“å‰å›¾ç‰‡çš„è®¾ç½®
      const regex = new RegExp(`!\\[([^\\]]*?)\\]\\(${imgId}\\)`);
      const match = content.match(regex);
      
      let align = 'center', size = 'medium';
      if (match) {
        const params = match[1].split('|');
        align = params.find(p => ['left', 'center', 'right'].includes(p)) || 'center';
        size = params.find(p => ['small', 'medium', 'large', 'full'].includes(p)) || 'medium';
      }
      
      document.getElementById('img-align').value = align;
      document.getElementById('img-size').value = size;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.align-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === align);
      });
      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === size);
      });
      
      // æ˜¾ç¤ºé¢„è§ˆ
      document.getElementById('img-preview').src = imageStore[imgId] || imgId;
      document.getElementById('image-editor-modal').classList.add('show');
    }
    
    function closeImageEditor() {
      document.getElementById('image-editor-modal').classList.remove('show');
      currentEditingImgId = null;
    }
    
    function applyImageSettings(closeAfter = true) {
      if (!currentEditingImgId) return;
      
      const align = document.getElementById('img-align').value;
      const size = document.getElementById('img-size').value;
      const textarea = document.getElementById('memo-content');
      
      // æ›¿æ¢å›¾ç‰‡æ ‡è®°
      const regex = new RegExp(`!\\[[^\\]]*?\\]\\(${currentEditingImgId}\\)`);
      textarea.value = textarea.value.replace(regex, `![å›¾ç‰‡|${align}|${size}](${currentEditingImgId})`);
      
      updatePreview();
      
      if (closeAfter) {
        closeImageEditor();
        showToast('å›¾ç‰‡è®¾ç½®å·²æ›´æ–°');
      }
    }
    
    function deleteImage() {
      if (!currentEditingImgId) return;
      if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;
      
      const textarea = document.getElementById('memo-content');
      const regex = new RegExp(`\\n?!\\[[^\\]]*?\\]\\(${currentEditingImgId}\\)\\n?`);
      textarea.value = textarea.value.replace(regex, '\n');
      
      delete imageStore[currentEditingImgId];
      updatePreview();
      closeImageEditor();
      showToast('å›¾ç‰‡å·²åˆ é™¤');
    }
    
    function setAlign(value) {
      document.getElementById('img-align').value = value;
      document.querySelectorAll('.align-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
      });
      // å®æ—¶é¢„è§ˆï¼Œä¸å…³é—­å¼¹çª—
      applyImageSettings(false);
    }
    
    function setSize(value) {
      document.getElementById('img-size').value = value;
      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
      });
      // å®æ—¶é¢„è§ˆï¼Œä¸å…³é—­å¼¹çª—
      applyImageSettings(false);
    }
    
    // ========== ä¸»é¢˜åˆ‡æ¢ ==========
    let currentTheme = 'memo';
    
    function switchTheme(theme) {
      currentTheme = theme;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
      
      // æ›´æ–°é¢„è§ˆåŒºåŸŸçš„ä¸»é¢˜ç±»
      const previewContainer = document.getElementById('preview-container');
      const exportContainer = document.getElementById('export-container');
      
      // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
      previewContainer.classList.remove('theme-memo', 'theme-zhihu', 'theme-dark');
      exportContainer.classList.remove('theme-memo', 'theme-zhihu', 'theme-dark');
      
      // æ·»åŠ å½“å‰ä¸»é¢˜ç±»
      previewContainer.classList.add(`theme-${theme}`);
      exportContainer.classList.add(`theme-${theme}`);
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('noteTheme', theme);
      
      updatePreview();
    }
    
    // åˆå§‹åŒ–ä¸»é¢˜
    function initTheme() {
      const savedTheme = localStorage.getItem('noteTheme') || 'memo';
      switchTheme(savedTheme);
    }
    
    function calculatePages(content) {
      // æ¯é¡µæœ€å¤§è¡Œæ•°ï¼ˆç®€å•å¯é ï¼‰
      const firstPageLines = 18;   // ç¬¬ä¸€é¡µæœ‰æ ‡é¢˜ï¼Œå°‘æ”¾å‡ è¡Œ
      const otherPageLines = 22;   // å…¶ä»–é¡µå¯ä»¥å¤šæ”¾
      
      const lines = content.split('\n');
      const pages = [];
      let currentPageLines = [];
      let isFirstPage = true;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();
        
        // è·³è¿‡è¡¨æ ¼åˆ†éš”è¡Œï¼ˆ|---|---|ï¼‰ä¸å è¡Œæ•°
        if (/^\|[-:\s|]+\|$/.test(trimmed)) {
          currentPageLines.push(line);
          continue;
        }
        
        // è®¡ç®—è¿™ä¸€è¡Œå å¤šå°‘"é€»è¾‘è¡Œ"
        let lineCount = 1;
        
        // è¡¨æ ¼è¡Œå 1è¡Œ
        if (/^\|.+\|$/.test(trimmed)) {
          lineCount = 1;
        }
        // æ ‡é¢˜å—å 1.5è¡Œ
        else if (trimmed.startsWith('ã€') && trimmed.endsWith('ã€‘')) {
          lineCount = 1.5;
        }
        // å›¾ç‰‡å 4è¡Œ
        else if (trimmed.startsWith('![') && trimmed.includes('](')) {
          lineCount = 4;
        }
        // ç©ºè¡Œå 0.5è¡Œ
        else if (!trimmed) {
          lineCount = 0.5;
        }
        // é•¿æ–‡æœ¬è¡Œå¯èƒ½å å¤šè¡Œ
        else if (line.length > 35) {
          lineCount = Math.ceil(line.length / 35);
        }
        
        const maxLines = isFirstPage ? firstPageLines : otherPageLines;
        const currentCount = currentPageLines.filter(l => !/^\|[-:\s|]+\|$/.test(l.trim())).length;
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢é¡µ
        if (currentCount + lineCount > maxLines && currentPageLines.length > 0) {
          pages.push(currentPageLines.join('\n'));
          currentPageLines = [line];
          isFirstPage = false;
        } else {
          currentPageLines.push(line);
        }
      }
      if (currentPageLines.length > 0) pages.push(currentPageLines.join('\n'));
      return pages.length > 0 ? pages : [''];
    }
    
    function parseSubtitle(text) {
      if (!text.trim()) return null;
      const match = text.match(/^(.+?)\s*(\d+)\s*$/);
      if (match) return { text: match[1].trim(), number: match[2] };
      return { text: text, number: null };
    }
    
    function generatePageHTML(title, subtitle, content, pageNum, total) {
      const parsedContent = parseContent(content);
      const showPageNum = total > 1;
      const subtitleData = parseSubtitle(subtitle);
      
      let subtitleHTML = '';
      if (subtitleData) {
        subtitleHTML = `<div class="memo-subtitle">${subtitleData.text}${subtitleData.number ? `<span class="tag">${subtitleData.number}</span>` : ''}</div>`;
      }
      
      const isFirstPage = pageNum === 1;
      
      return `
        <div class="memo-page">
          <div class="memo-inner ${!isFirstPage ? 'no-title' : ''}">
            ${isFirstPage ? `<div class="memo-title">${title}</div>${subtitleHTML}` : ''}
            <div class="memo-body"><div class="memo-content">${parsedContent}</div></div>
            ${showPageNum ? `<div class="page-indicator">${pageNum} / ${total}</div>` : ''}
          </div>
        </div>
      `;
    }
    
    function updatePreview(resetToFirstPage = false) {
      const title = document.getElementById('memo-title').value || 'æ ‡é¢˜';
      const subtitle = document.getElementById('memo-subtitle').value || '';
      const content = document.getElementById('memo-content').value || '';
      
      pagesData = calculatePages(content);
      totalPages = pagesData.length;
      
      // å¦‚æœéœ€è¦é‡ç½®åˆ°ç¬¬ä¸€é¡µï¼ˆæ¯”å¦‚ç²˜è´´æ–°å†…å®¹æ—¶ï¼‰
      if (resetToFirstPage) {
        currentPage = 0;
      } else {
        if (currentPage >= totalPages) currentPage = totalPages - 1;
        if (currentPage < 0) currentPage = 0;
      }
      
      document.getElementById('pages-container').innerHTML = generatePageHTML(title, subtitle, pagesData[currentPage], currentPage + 1, totalPages);
      
      let exportHTML = '';
      for (let i = 0; i < totalPages; i++) {
        exportHTML += `<div class="export-page" data-page="${i}">${generatePageHTML(title, subtitle, pagesData[i], i + 1, totalPages)}</div>`;
      }
      document.getElementById('export-container').innerHTML = exportHTML;
      
      document.getElementById('page-info').textContent = `ğŸ“„ å…± ${totalPages} é¡µ`;
      document.getElementById('page-display').textContent = `${currentPage + 1} / ${totalPages}`;
      document.getElementById('btn-prev').disabled = currentPage === 0;
      document.getElementById('btn-next').disabled = currentPage === totalPages - 1;
    }
    
    function prevPage() { if (currentPage > 0) { currentPage--; updatePreview(); } }
    function nextPage() { if (currentPage < totalPages - 1) { currentPage++; updatePreview(); } }
    
    function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }
    
    async function downloadCurrentPage() {
      showLoading(true);
      try {
        const el = document.querySelector(`.export-page[data-page="${currentPage}"] .memo-page`);
        const bgColor = currentTheme === 'dark' ? '#1a1a2e' : '#fefefe';
        const canvas = await html2canvas(el, { width: 1080, height: 1440, scale: 1, useCORS: true, backgroundColor: bgColor });
        const link = document.createElement('a');
        link.download = `${currentPage + 1}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (e) { alert('ä¸‹è½½å¤±è´¥'); console.error(e); }
      showLoading(false);
    }
    
    async function downloadAllPages() {
      if (totalPages === 1) {
        // åªæœ‰ä¸€é¡µç›´æ¥ä¸‹è½½å›¾ç‰‡
        return downloadCurrentPage();
      }
      
      showLoading(true);
      try {
        const zip = new JSZip();
        
        for (let i = 0; i < totalPages; i++) {
          const el = document.querySelector(`.export-page[data-page="${i}"] .memo-page`);
          const bgColor = currentTheme === 'dark' ? '#1a1a2e' : '#fefefe';
          const canvas = await html2canvas(el, { width: 1080, height: 1440, scale: 1, useCORS: true, backgroundColor: bgColor });
          
          // å°†canvasè½¬ä¸ºblob
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
          
          // æ·»åŠ åˆ°zipï¼Œæ–‡ä»¶åä¸º 1.png, 2.png, 3.png...
          zip.file(`${i + 1}.png`, blob);
        }
        
        // ç”Ÿæˆzipæ–‡ä»¶å¹¶ä¸‹è½½
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = `å°çº¢ä¹¦ç¬”è®°_${totalPages}é¡µ.zip`;
        link.click();
        URL.revokeObjectURL(link.href);
        
        showToast(`å·²æ‰“åŒ… ${totalPages} å¼ å›¾ç‰‡`);
      } catch (e) { 
        alert('ä¸‹è½½å¤±è´¥: ' + e.message); 
        console.error(e); 
      }
      showLoading(false);
    }
    
    // åˆå§‹åŒ–
    initTheme();
    updatePreview();
    updateBackupStatus();
    setupImageDrag();
  </script>
</body>
</html>
